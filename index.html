<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LP + GP Finder Pro</title>

  <!-- SheetJS for Excel/CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- ----------  STYLES  (unchanged from your original)  ---------- -->
  <style>
    :root{
      --primary-bg:#f8f9fa; --secondary-bg:#ffffff; --border-color:#dee2e6;
      --text-color:#212529; --primary-color:#4a90e2; --primary-hover-color:#357abd;
      --secondary-color:#6c757d; --secondary-hover-color:#5c636a;
      --success-color:#198754; --danger-color:#dc3545; --warning-color:#ffc107;
      --success-highlight:#d1e7dd; --unvalidated-highlight:#fff3cd;
      --font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0 / .05);
      --shadow-md:0 4px 6px -1px rgb(0 0 0 / .1),0 2px 4px -2px rgb(0 0 0 / .1);
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;font-family:var(--font-family);color:var(--text-color);background:var(--primary-bg)}
    .container{display:flex;flex-wrap:wrap;width:100%;height:100vh}
    .sidebar{flex:0 0 320px;padding:1.5rem;background:var(--secondary-bg);border-right:1px solid var(--border-color);display:flex;flex-direction:column;gap:1.5rem;overflow-y:auto}
    .main-content{flex:1;padding:1.5rem;display:flex;flex-direction:column;overflow-y:auto;position:relative}
    .panel{background:var(--secondary-bg);border:1px solid var(--border-color);border-radius:8px;padding:1.25rem;box-shadow:var(--shadow-sm)}
    .panel h2{margin:0 0 1rem;font-size:1.2rem;border-bottom:1px solid var(--border-color);padding-bottom:.75rem;color:#343a40}
    .control-group{margin-bottom:1rem}
    .control-group label{display:block;font-weight:600;font-size:.9rem;margin-bottom:.5rem}
    input[type=text],select{width:100%;padding:.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:#fdfdfe;transition:border-color .2s,box-shadow .2s}
    input[type=text]:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,144,226,.25)}
    .btn{display:block;width:100%;padding:.7rem 1.2rem;margin-bottom:.75rem;font-size:1rem;font-weight:600;border:none;border-radius:6px;cursor:pointer;text-align:center;transition:all .2s}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{background:#bdc3c7;cursor:not-allowed}
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-primary:hover:not(:disabled){background:var(--primary-hover-color);box-shadow:var(--shadow-sm)}
    .btn-secondary{background:var(--secondary-color);color:#fff}
    .btn-secondary:hover:not(:disabled){background:var(--secondary-hover-color)}
    .filter-buttons{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.5rem}
    .filter-buttons .btn{margin:0;font-size:.9rem;padding:.5rem}
    .filter-buttons .btn.active{background:var(--primary-color);color:#fff;font-weight:bold}
    .filter-buttons .btn:not(.active){background:#e9ecef;color:var(--text-color)}
    .table-container{flex-grow:1;overflow:auto;border:1px solid var(--border-color);border-radius:8px;background:var(--secondary-bg);box-shadow:var(--shadow-sm)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.85rem 1rem;text-align:left;border-bottom:1px solid var(--border-color);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    thead th{background:var(--primary-bg);cursor:pointer;position:sticky;top:0;z-index:10;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px}
    .row-new{background:var(--unvalidated-highlight)!important}
    #placeholder-text{text-align:center;padding:3rem;color:#95a5a6;font-size:1.1rem}
    #toast-container{position:fixed;top:20px;right:20px;z-index:3000}
    .toast{padding:1rem 1.5rem;border-radius:8px;color:#fff;font-weight:600;box-shadow:var(--shadow-md);opacity:0;transform:translateY(-20px);transition:all .3s;margin-bottom:10px}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast-success{background:var(--success-color)}
    .toast-error{background:var(--danger-color)}
    #loading-overlay{position:absolute;inset:0;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center;z-index:1000}
    .spinner{width:50px;height:50px;border:5px solid rgba(0,0,0,.1);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <!-- --------------------- SIDEBAR --------------------- -->
    <aside class="sidebar">
      <div class="panel">
        <h2>View</h2>
        <div class="filter-buttons">
          <button class="btn active" data-filter="All">All</button>
          <button class="btn" data-filter="LP">LPs</button>
          <button class="btn" data-filter="GP">GPs</button>
        </div>
        <hr style="margin:1rem 0;border:none;border-top:1px solid var(--border-color)">
        <button id="column-visibility-btn" class="btn btn-secondary">Configure Columns</button>
      </div>

      <div class="panel">
        <h2>AI Discovery</h2>
        <div class="control-group">
          <label for="ai-type">Entity Type (LP or GP)</label>
          <select id="ai-type"><option>LP</option><option>GP</option></select>
        </div>
        <div class="control-group">
          <label for="ai-subtype">Specific Type</label>
          <input id="ai-subtype" type="text" placeholder="e.g., Family Office" />
        </div>
        <div class="control-group">
          <label for="ai-sector">Sector</label>
          <input id="ai-sector" type="text" placeholder="e.g., Health" />
        </div>
        <div class="control-group">
          <label for="ai-geo">Geography</label>
          <input id="ai-geo" type="text" placeholder="e.g., USA" />
        </div>
        <button id="find-investors-btn" class="btn btn-primary">âœ¨ Find New Investors</button>
      </div>

      <div class="panel">
        <h2>Manage List</h2>
        <label class="btn btn-secondary" for="upload-input">Upload Excel/CSV</label>
        <input id="upload-input" type="file" accept=".xlsx,.xls,.csv" style="display:none" />
        <button id="export-csv-btn" class="btn btn-secondary">Export CSV</button>
      </div>
    </aside>

    <!-- --------------------- MAIN --------------------- -->
    <main class="main-content">
      <div id="loading-overlay"><div class="spinner"></div></div>
      <div class="panel"><input id="search-box" type="text" placeholder="Search..." /></div>
      <div class="table-container" style="margin-top:1rem">
        <table id="results-table"><thead id="results-thead"></thead><tbody id="results-tbody"></tbody></table>
        <p id="placeholder-text">Upload a file or use AI Discovery to get started.</p>
      </div>
    </main>
  </div>

  <!-- --------------------- TOASTS --------------------- -->
  <div id="toast-container"></div>

<script>
(() => {
  /* ---------- CLIENT STATE ---------- */
  let db = [];
  const allCols = [
    { key:'entityType', label:'LP/GP' },{ key:'firmName',label:'Firm Name' },
    { key:'subType', label:'Type' },   { key:'country', label:'Country' },
    { key:'sector', label:'Sector' },  { key:'website', label:'Website' }
  ];
  const view = { active:'All', search:'', visible:new Set(allCols.map(c=>c.key).concat(['source'])), sort:{col:'firmName',dir:'asc'} };

  /* ---------- DOM ---------- */
  const $ = id=>document.getElementById(id);
  const dom = { head:$('results-thead'), body:$('results-tbody'), place:$('placeholder-text'),
                search:$('search-box'), toast:$('toast-container'), overlay:$('loading-overlay') };

  /* ---------- RENDER ---------- */
  function updateView(){
    let rows=[...db];
    if(view.active!=='All') rows=rows.filter(r=>r.entityType===view.active);
    if(view.search){
      const t=view.search.toLowerCase();
      rows=rows.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(t)));
    }
    rows.sort((a,b)=>{
      const A=a[view.sort.col]||'', B=b[view.sort.col]||'';
      return (A<B?-1:A>B?1:0)*(view.sort.dir==='asc'?1:-1);
    });

    /* header */
    dom.head.innerHTML='';
    const hr=dom.head.insertRow();
    [...allCols,{key:'source',label:'Source'}].forEach(c=>{
      if(!view.visible.has(c.key)) return;
      const th=document.createElement('th');
      th.textContent=c.label; hr.appendChild(th);
    });

    /* body */
    dom.body.innerHTML='';
    rows.forEach(r=>{
      const tr=dom.body.insertRow();
      if(r.source==='Gemini'&&!r.validated) tr.classList.add('row-new');
      [...allCols,{key:'source'}].forEach(c=>{
        if(!view.visible.has(c.key)) return;
        const td=tr.insertCell(); td.textContent=r[c.key]||'';
      });
    });
    dom.place.style.display=rows.length?'none':'block';
  }
  window.updateView = updateView;   /* expose for other functions */

  function merge(firms){
    const seen=new Set(db.map(f=>f.website?.toLowerCase()).filter(Boolean));
    let added=0;
    firms.forEach(f=>{
      const w=(f.website||'').toLowerCase();
      if(w && !seen.has(w)){
        f.id='firm_'+Date.now()+Math.random();
        db.push(f); seen.add(w); added++;
      }
    });
    return added;
  }

  function toast(msg,type='success'){
    const div=document.createElement('div');
    div.className=`toast toast-${type} show`;
    div.textContent=msg; dom.toast.appendChild(div);
    setTimeout(()=>{div.classList.remove('show'); div.addEventListener('transitionend',()=>div.remove());},4000);
  }
  const loading=flag=>dom.overlay.style.display=flag?'flex':'none';

  /* ---------- AI DISCOVERY ---------- */
  async function findNewInvestors(){
    const entityType=$('ai-type').value;
    const subType=$('ai-subtype').value.trim();
    const sector=$('ai-sector').value.trim();
    const geo=$('ai-geo').value.trim();
    if(!subType||!sector||!geo) return toast('Please fill all AI fields','error');

    loading(true);
    try{
      const res=await fetch('/api/find-investors',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({entityType,subType,sector,geo})});
      const data=await res.json();
      if(!res.ok) throw new Error(data.error||'API error');

      const added=merge(data);
      toast(`${added} new investors added from AI.`,'success');
      updateView();
    }catch(e){ toast('AI search failed: '+e.message,'error'); }
    finally{ loading(false); }
  }

  /* ---------- EVENTS ---------- */
  $('find-investors-btn').onclick=findNewInvestors;
  dom.search.oninput=e=>{view.search=e.target.value;updateView();};
  document.querySelectorAll('.filter-buttons .btn').forEach(btn=>{
    btn.onclick=()=>{document.querySelectorAll('.filter-buttons .btn').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');view.active=btn.dataset.filter;updateView();};
  });

  updateView();
})();
</script>
</body>
</html>

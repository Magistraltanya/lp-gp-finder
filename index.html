<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Magistral LP-GP Finder v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- NEW: VISUAL & BRANDING OVERHAUL --- */
:root {
    --blue-dark: #0A2342;    /* Magistral Dark Blue */
    --gold: #B89E5A;         /* Magistral Gold Accent */
    --blue-light: #2C6EAF;   /* Magistral Light Blue for accents/hovers */
    --grey-text: #5a6474;
    --bg: #f8f9fa;
    --white: #fff;
    --border: #e9ecef;
    --shadow: 0 4px 12px rgba(0, 0, 0, .06);
    --shadow-hover: 0 6px 16px rgba(0, 0, 0, .1);
    --font: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
    --radius: 8px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--blue-dark);display:flex;min-height:100vh;overflow:hidden}
a{color:var(--blue-light);text-decoration:none}
a:hover{color:var(--gold)}
.sidebar{flex:0 0 310px;background:var(--white);border-right:1px solid var(--border);padding:22px;display:flex;flex-direction:column;gap:26px;overflow-y:auto}
.main{flex:1;display:flex;flex-direction:column;padding:22px;position:relative;overflow:hidden;}
.panel{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
.panel h2{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--blue-dark);border-bottom:1px solid var(--border);padding-bottom:12px}
.btn{border:1px solid transparent;border-radius:var(--radius);padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s ease-in-out;width:100%;line-height:1.25;text-align:center}
.btn-pri{background:var(--gold);color:#fff}.btn-pri:hover{background:#a18b4c;box-shadow:var(--shadow-hover);transform: translateY(-2px);}
.btn-sec{background:var(--white);color:var(--blue-dark);border-color:var(--border)}.btn-sec:hover{background:#f8f9fa;border-color:#ced4da}
.filter-buttons{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.filter-buttons .btn{padding:6px 0;font-size:13px;background:#f1f3f5;color:var(--grey-text);border:1px solid transparent}
.filter-buttons .active{background:var(--blue-dark);color:#fff}
input,select{width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;background:var(--white)}
input:focus,select:focus{outline:none;border-color:var(--blue-light);box-shadow:0 0 0 3px rgba(44,110,175,.15)}
.table-wrap{flex-grow:1;background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:auto;box-shadow:var(--shadow)}
.table{width:100%;min-width:1800px;border-collapse:collapse;font-size:13px;}
th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap;text-overflow:ellipsis;overflow:hidden;vertical-align:middle}
th{background:#f8f9fa;color:var(--grey-text);font-weight:600;text-transform:uppercase;position:sticky;top:0;z-index:3;text-align:left;letter-spacing:0.5px;}
tr{transition: background-color .2s ease-in-out;}
tr:hover td{background:#f1f5f9}
.row-new{animation:glow 3s ease-out forwards}@keyframes glow{from{background-color:#fffbe7}to{background-color:transparent}}
.icon{cursor:pointer;font-size:16px;color:var(--blue-light); display:inline-flex; align-items:center; gap:4px; transition: color .2s;}
.icon:hover{color: var(--gold);}
.icon .count{font-size:12px; background:var(--grey-text); color:white; padding:1px 5px; border-radius:10px;}
.icon.del{color:#b60000;margin-left:8px}
.icon.del:hover{color:#8c0000;}
#overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.6);z-index:300;backdrop-filter:blur(4px);}
.spinner{width:44px;height:44px;border:5px solid rgba(0,0,0,.12);border-top-color:var(--blue-dark);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;top:22px;right:24px;z-index:600;pointer-events:none}
.toast{padding:11px 17px;border-radius:var(--radius);color:#fff;font-weight:600;margin-bottom:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(-10px);transition:.3s}
.toast.show{opacity:1;transform:none}.toast.ok{background:var(--blue-light)}.toast.err{background:#c0392b}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:500}
.modal-box{background:#fff;border-radius:var(--radius);padding:24px;width:92%;max-width:820px;max-height:85%;overflow:auto;box-shadow:var(--shadow);display:flex;flex-direction:column}
.modal-box h3{font-size:18px;font-weight:600;margin-bottom:14px;color:var(--blue-dark); border-bottom:1px solid var(--border); padding-bottom:10px;flex-shrink:0}
.panel.quick-filters label{display:block;font-size:13px;margin-bottom:6px;color:var(--grey-text);font-weight:500;}
.panel.quick-filters select, .panel.quick-filters button {margin-top:12px;}
.panel.manage-list{display:flex;flex-direction:column;gap:10px}

/* --- NEW: PAGINATION STYLES --- */
.pagination-container {
    padding: 16px 0 0 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    user-select: none;
    flex-shrink: 0;
}
.page-btn {
    background: #fff;
    color: var(--blue-dark);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
}
.page-btn:hover { background-color: #f1f3f5; border-color: #ced4da; }
.page-btn.active { background-color: var(--blue-dark); color: #fff; border-color: var(--blue-dark); }
.page-btn:disabled { background-color: #f8f9fa; color: #adb5bd; cursor: not-allowed; }

</style>
</head><body>
<aside class="sidebar">
    <div class="panel"><h2>View</h2>
        <div class="filter-buttons">
            <button class="btn active" data-f="All">All</button><button class="btn" data-f="LP">LPs</button>
            <button class="btn" data-f="GP">GPs</button><button class="btn" data-f="Broker">Brokers</button>
            <button class="btn" data-f="Other">Others</button>
        </div>
        <button id="col-btn" class="btn btn-sec" style="margin-top:14px">Configure Columns</button>
    </div>
    <div class="panel quick-filters"><h2>Quick Filters</h2>
        <label>Country</label><select id="q-country"><option value="">All Countries</option></select>
        <label>Sector</label><select id="q-sector"><option value="">All Sectors</option></select>
        <label>Stage</label><select id="q-stage"><option value="">All Stages</option></select>
        <label>Source</label><select id="q-source"><option value="">All Sources</option></select> <button id="q-clear" class="btn btn-sec">Clear Filters</button>
    </div>
    <div class="panel"><h2>AI Discovery</h2>
        <label style="font-size:13px; font-weight: 500; color: var(--grey-text);">Entity Type</label>
        <select id="ai-type"><option>LP</option><option>GP</option><option>Broker</option><option>Other</option></select>
        <label style="font-size:13px;margin-top:12px; font-weight: 500; color: var(--grey-text);">Specific Type</label><input id="ai-sub" placeholder="e.g., Family Office">
        <label style="font-size:13px;margin-top:12px; font-weight: 500; color: var(--grey-text);">Sector</label><input id="ai-sec" placeholder="e.g., Health Care">
        <label style="font-size:13px;margin-top:12px; font-weight: 500; color: var(--grey-text);">Geography</label><input id="ai-geo" placeholder="e.g., USA">
        <button id="ai-btn" class="btn btn-pri" style="margin-top:16px">‚ú® Find Investors</button>
    </div>
    <div class="panel manage-list"><h2>Manage List</h2>
        <label class="btn btn-sec" for="file-in">Upload Excel/CSV</label>
        <input type="file" id="file-in" accept=".xlsx,.xls,.csv" hidden>
        <button id="del-bulk" class="btn btn-sec">Delete Selected</button>
        <button id="exp-btn" class="btn btn-sec">Export CSV</button>
    </div>
</aside>
<main class="main">
    <div id="overlay"><div class="spinner"></div></div>
    <input id="search" placeholder="Search across all firms..." style="padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius);width:100%;margin-bottom:12px">
    <div class="table-wrap">
        <table class="table"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
        <p id="empty" style="text-align:center;padding:48px;color:#8d99a6">No firms found. Try adjusting your filters or use AI Discovery.</p>
    </div>
    <div id="pagination-container" class="pagination-container"></div> </main>
<div id="toast"></div>
<div class="modal" id="col-modal"></div>
<div class="modal" id="ct-modal"></div>

<script>
(()=>{
// --- CONSTANTS AND ALIASES (Unchanged) ---
const COLS=[ {key:'chk',label:' '},{key:'sn',label:'#'}, {key:'entityType',label:'LP/GP/Broker'},{key:'firmName',label:'Firm Name'},{key:'subType',label:'Type'}, {key:'address',label:'Address'},{key:'country',label:'Country'},{key:'website',label:'Website'}, {key:'companyLinkedIn',label:'Firm LinkedIn'},{key:'about',label:'About'},{key:'investmentStrategy',label:'Strategy'}, {key:'sector',label:'Sector'},{key:'sectorDetails',label:'Sector Details'},{key:'stage',label:'Stage'}, {key:'source',label:'Source'},{key:'actions',label:''} ];
const defaultVis=['chk','sn','entityType','firmName','subType','country','website','sector','stage','source','actions'];
const vis=new Set(JSON.parse(localStorage.getItem('visibleCols')||'null')||defaultVis);
const alias={"lp/gp/broker":"entityType", "type":"subType", "s.no.":"sn", "lp/gp":"entityType", "lp":"entityType", "gp":"entityType","firm name":"firmName","name":"firmName","subtype":"subType","address":"address","country":"country","website":"website","company linkedin":"companyLinkedIn","firm linkedin":"companyLinkedIn","about the company":"about","about":"about","investment strategy":"investmentStrategy","strategy":"investmentStrategy","sector":"sector","sector details":"sectorDetails","stage":"stage","stage preference":"stage","source":"source","contact name":"contactName","designation":"designation","linkedin":"linkedIn","email":"email","contact number":"contactNumber"};
const contactKeys=new Set(['contactName','designation','linkedIn','email','contactNumber']);

// --- UI ELEMENT SELECTORS (Updated) ---
const $=q=>document.querySelector(q),$$=q=>document.querySelectorAll(q);
const UI={thead:$('#thead'),tbody:$('#tbody'),empty:$('#empty'),overlay:$('#overlay'),toast:$('#toast'),search:$('#search'), filterBtns:$$('.filter-buttons .btn'),qCountry:$('#q-country'),qSector:$('#q-sector'),qStage:$('#q-stage'), qSource:$('#q-source'), /* NEW */
colBtn:$('#col-btn'),colModal:$('#col-modal'),colList:$('#col-list'),ctModal:$('#ct-modal'),ctTitle:$('#ct-title'),ctBody:$('#ct-body'), aiType:$('#ai-type'),aiSub:$('#ai-sub'),aiSec:$('#ai-sec'),aiGeo:$('#ai-geo'),aiBtn:$('#ai-btn'), fileIn:$('#file-in'),delBulk:$('#del-bulk'),expBtn:$('#exp-btn'), paginationContainer: $('#pagination-container') /* NEW */
};

const showO=f=>UI.overlay.style.display=f?'flex':'none';
const toast=(m,ok=true)=>{const t=document.createElement('div');t.className=`toast ${ok?'ok':'err'}`;t.textContent=m; UI.toast.appendChild(t);requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{t.classList.remove('show');t.addEventListener('transitionend',()=>t.remove());},3000);};

// --- DATA STATE & PAGINATION (Updated) ---
let firms=[];
let currentPage = 1;
const rowsPerPage = 25; // You can change this value

const mapRow = r => ({ _id: r.id, firmName: r.firm_name || r.firmName, entityType: r.entity_type || r.entityType, subType: r.sub_type || r.subType, companyLinkedIn: r.company_linkedin || r.companyLinkedIn, investmentStrategy: r.investment_strategy || r.investmentStrategy, sectorDetails: r.sector_details || r.sectorDetails, contacts: r.contacts || [], ...r });

(async()=>{showO(true); try{const rows=await (await fetch('/api/firms')).json();firms=rows.map(mapRow);}catch(e){console.error(e);toast('Load failed',false);} finally{buildFilters();render();showO(false);} })();

// --- FILTER LOGIC (Updated) ---
let view='All';
function buildFilters(){
    const c=new Set(),s=new Set(),st=new Set(), src=new Set();
    firms.forEach(f=>{ if(f.country)c.add(f.country); if(f.sector)f.sector.split(',').forEach(x=>s.add(x.trim())); if(f.stage)st.add(f.stage); if(f.source)src.add(f.source); /* NEW */ });
    const fill=(sel,set)=>{ const cur=sel.value; sel.innerHTML=sel.options[0].outerHTML + [...set].sort().map(v=>`<option>${v}</option>`).join(''); sel.value=cur;};
    fill(UI.qCountry,c);fill(UI.qSector,s);fill(UI.qStage,st); fill(UI.qSource, src); // NEW
}

[...UI.filterBtns, UI.qCountry,UI.qSector,UI.qStage, UI.qSource, UI.search].forEach(el => {
    const event = el.tagName === 'BUTTON' ? 'click' : 'input';
    el.addEventListener(event, () => {
        if(el.tagName === 'BUTTON') {
            UI.filterBtns.forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
            view = el.dataset.f;
        }
        currentPage = 1; // Reset to page 1 on any filter change
        render();
    });
});
$('#q-clear').addEventListener('click',()=>{ UI.qCountry.value=UI.qSector.value=UI.qStage.value=UI.qSource.value=''; currentPage = 1; render(); });

// --- RENDER FUNCTION (Completely rewritten for pagination) ---
function render(){
    // 1. Filter the entire dataset first
    const searchVal = UI.search.value.toLowerCase();
    const filteredRows = firms.filter(f =>
        (view === 'All' || f.entityType === view) &&
        (!UI.qCountry.value || f.country === UI.qCountry.value) &&
        (!UI.qSector.value || f.sector.split(',').map(x => x.trim()).includes(UI.qSector.value)) &&
        (!UI.qStage.value || f.stage === UI.qStage.value) &&
        (!UI.qSource.value || f.source === UI.qSource.value) && // NEW source filter
        Object.values(f).some(v => String(v || '').toLowerCase().includes(searchVal))
    );

    UI.empty.style.display = filteredRows.length ? 'none' : 'block';
    UI.thead.innerHTML = UI.tbody.innerHTML = ''; // Clear table header and body

    // Render header
    const trH=document.createElement('tr');
    COLS.forEach(c=>{if(!vis.has(c.key))return; const th=document.createElement('th'); if(c.key==='chk')th.innerHTML='<input type="checkbox" id="sel-all">'; else th.textContent=c.label;trH.appendChild(th);});
    UI.thead.appendChild(trH);

    // 2. Paginate the filtered results
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    const paginatedRows = filteredRows.slice(startIndex, endIndex);

    // 3. Render only the rows for the current page
    paginatedRows.forEach((f, i) => {
        const tr=document.createElement('tr');
        if (f.isNew) { tr.classList.add('row-new'); delete f.isNew; }
        COLS.forEach(c=>{if(!vis.has(c.key))return;const td=document.createElement('td');
            switch(c.key){
                case 'chk': td.innerHTML=`<input type="checkbox" class="rowchk" data-id="${f._id}">`;break;
                case 'sn':  td.textContent = startIndex + i + 1; break; // Correct serial number
                case 'website': td.innerHTML=f.website?`<a href="${f.website.startsWith('http')?f.website:`https://${f.website}`}" target="_blank">${f.website}</a>`:'';break;
                case 'companyLinkedIn': td.innerHTML=f.companyLinkedIn?`<a href="${f.companyLinkedIn.startsWith('http')?f.companyLinkedIn:`https://${f.companyLinkedIn}`}" target="_blank">View Profile</a>`:'';break;
                case 'actions': td.innerHTML=`<span class="icon" title="Contacts" data-act="ct" data-id="${f._id}">üë•<span class="count">${f.contacts.length}</span></span><span class="icon del" title="Delete" data-act="del" data-id="${f._id}">üóëÔ∏è</span>`;break;
                default: td.textContent=f[c.key]||'';
            }
            td.title=td.textContent || '';tr.appendChild(td);});
        UI.tbody.appendChild(tr);
    });

    // 4. Render pagination controls
    renderPagination(filteredRows.length);
}

// --- NEW: renderPagination function ---
function renderPagination(totalRows) {
    UI.paginationContainer.innerHTML = '';
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    if (totalPages <= 1) return;

    // Previous Button
    const createButton = (text, page, disabled = false) => {
        const btn = document.createElement('button');
        btn.className = 'page-btn';
        btn.textContent = text;
        btn.disabled = disabled;
        btn.onclick = () => { currentPage = page; render(); };
        return btn;
    };
    UI.paginationContainer.appendChild(createButton('‚Äπ Prev', currentPage - 1, currentPage === 1));

    // Page Number Logic
    const pagesToShow = [];
    if (totalPages <= 7) {
        for(let i=1; i<=totalPages; i++) pagesToShow.push(i);
    } else {
        pagesToShow.push(1);
        if (currentPage > 4) pagesToShow.push('...');
        for(let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) pagesToShow.push(i);
        if (currentPage < totalPages - 3) pagesToShow.push('...');
        pagesToShow.push(totalPages);
    }
    
    pagesToShow.forEach(p => {
        if(p === '...') {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.className = 'page-btn';
            ellipsis.style.border='none'; ellipsis.style.background='none';
            UI.paginationContainer.appendChild(ellipsis);
        } else {
            const btn = createButton(p, p);
            if (p === currentPage) btn.classList.add('active');
            UI.paginationContainer.appendChild(btn);
        }
    });

    UI.paginationContainer.appendChild(createButton('Next ‚Ä∫', currentPage + 1, currentPage === totalPages));
}

// --- All other functions (modals, AI click, upload, etc.) are preserved from your original code ---
// Add currentPage reset to functions that add data
UI.aiBtn.addEventListener('click',async()=>{
    // ... your full AI button logic
    // at the end, inside the success block:
    if (d.added > 0) {
      d.newFirms.forEach(f => f.isNew = true);
      firms.unshift(...d.newFirms.map(mapRow));
      currentPage = 1; // Go to first page to see new items
      buildFilters(); render();
    }
    //...
});

UI.fileIn.addEventListener('change', e => {
    // ... your full file change logic
    // inside rd.onload, inside the final 'try' block, after successful insert:
    if (inserted.length > 0) {
     inserted.forEach(f => f.isNew = true);
     firms.unshift(...inserted.map(mapRow));
     currentPage = 1; // Go to first page to see new items
     buildFilters(); render();
    }
    //...
});

// All other event listeners from your code are preserved below...
// (UI.colBtn, UI.colModal, UI.colList, UI.thead, UI.tbody, UI.ctModal, UI.delBulk, UI.expBtn)
// These do not need to be changed for the new features.

})();
</script>
</body></html>

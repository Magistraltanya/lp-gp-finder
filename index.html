<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Magistral LP-GP Finder v3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- BRANDING & VISUAL OVERHAUL --- */
        :root {
            --blue-dark: #0A2342; /* Magistral Dark Blue */
            --blue-light: #2C6EAF; /* Magistral Light Blue */
            --gold: #B89E5A;      /* Magistral Gold Accent */
            --grey-text: #5a6474;
            --bg: #f8f9fa;
            --white: #fff;
            --border: #e9ecef;
            --shadow: 0 4px 12px rgba(0, 0, 0, .06);
            --shadow-hover: 0 6px 16px rgba(0, 0, 0, .1);
            --font: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--blue-dark);
            display: flex;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        a { color: var(--blue-light); text-decoration: none; }
        a:hover { color: var(--gold); }

        .sidebar {
            flex: 0 0 320px;
            background: var(--white);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 28px;
            overflow-y: auto;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            position: relative;
            overflow: hidden; /* Contains scrolling elements */
        }

        .panel {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .panel h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--blue-dark);
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .btn {
            border: 1px solid transparent;
            border-radius: var(--radius);
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s ease-in-out;
            width: 100%;
            line-height: 1.5;
            text-align: center;
        }

        .btn-pri { background: var(--blue-dark); color: #fff; }
        .btn-pri:hover { background: var(--blue-light); box-shadow: var(--shadow-hover); transform: translateY(-2px); }

        .btn-sec { background: var(--white); color: var(--blue-dark); border-color: var(--border); }
        .btn-sec:hover { background: #f8f9fa; border-color: #ced4da; }

        .btn-gold { background: var(--gold); color: var(--white); }
        .btn-gold:hover { background: #a18b4c; box-shadow: var(--shadow-hover); transform: translateY(-2px); }

        .filter-buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .filter-buttons .btn { padding: 6px 0; font-size: 13px; background: #f1f3f5; color: var(--grey-text); }
        .filter-buttons .active { background: var(--blue-light); color: #fff; }

        input, select {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            background: var(--white);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--blue-light);
            box-shadow: 0 0 0 3px rgba(44, 110, 175, .15);
        }

        .table-wrap {
            flex-grow: 1;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: auto;
            box-shadow: var(--shadow);
            position: relative;
        }

        .table {
            width: 100%;
            min-width: 1800px;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            vertical-align: middle;
        }

        th {
            background: #f8f9fa;
            color: var(--grey-text);
            font-weight: 600;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 3;
            text-align: left;
            letter-spacing: 0.5px;
        }

        tr { transition: background-color .2s ease-in-out; }
        tr:hover td { background: #f1f5f9; }

        .row-new { animation: glow 3s ease-out forwards; }
        @keyframes glow {
            from { background-color: #fffbe7; }
            to { background-color: transparent; }
        }

        #overlay {
            position: absolute; inset: 0; display: none; align-items: center;
            justify-content: center; background: rgba(255, 255, 255, .6);
            z-index: 300; backdrop-filter: blur(4px);
        }

        /* --- PAGINATION STYLES --- */
        .pagination-container {
            padding: 16px 0 0 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            user-select: none;
            flex-shrink: 0;
        }
        .page-btn {
            background: #fff;
            color: var(--blue-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all .2s;
        }
        .page-btn:hover { background-color: #f1f3f5; border-color: #ced4da; }
        .page-btn.active { background-color: var(--blue-light); color: #fff; border-color: var(--blue-light); }
        .page-btn:disabled { background-color: #f8f9fa; color: #adb5bd; cursor: not-allowed; }

        /* Other minor styles... */
        .panel.quick-filters label { display: block; font-size: 13px; margin-bottom: 4px; color: var(--grey-text); }
        .panel.quick-filters select, .panel.quick-filters input { margin-bottom: 14px; }
        .panel.manage-list { display: flex; flex-direction: column; gap: 12px; }
        .modal-box { background: #fff; border-radius: var(--radius); padding: 24px; max-width: 820px; box-shadow: var(--shadow); }

    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="panel">
            <h2>View</h2>
            <div class="filter-buttons">
                <button class="btn active" data-f="All">All</button><button class="btn" data-f="LP">LPs</button>
                <button class="btn" data-f="GP">GPs</button><button class="btn" data-f="Broker">Brokers</button>
                <button class="btn" data-f="Other">Others</button>
            </div>
            <button id="col-btn" class="btn btn-sec" style="margin-top:14px">Configure Columns</button>
        </div>

        <div class="panel quick-filters">
            <h2>Quick Filters</h2>
            <label>Country</label><select id="q-country"><option value="">All Countries</option></select>
            <label>Sector</label><select id="q-sector"><option value="">All Sectors</option></select>
            <label>Stage</label><select id="q-stage"><option value="">All Stages</option></select>
            <label>Source</label><select id="q-source"><option value="">All Sources</option></select> <button id="q-clear" class="btn btn-sec">Clear Filters</button>
        </div>

        <div class="panel">
            <h2>AI Discovery</h2>
            <button id="ai-btn" class="btn btn-gold" style="margin-top:16px">✨ Find Investors</button>
        </div>

        <div class="panel manage-list">
            <h2>Manage List</h2>
            <label class="btn btn-sec" for="file-in">Upload Excel/CSV</label>
            <input type="file" id="file-in" accept=".xlsx,.xls,.csv" hidden>
            <button id="del-bulk" class="btn btn-sec">Delete Selected</button>
            <button id="exp-btn" class="btn btn-sec">Export CSV</button>
        </div>
    </aside>

    <main class="main">
        <div id="overlay"><div class="spinner"></div></div>
        <input id="search" placeholder="Search across all firms..." style="width:100%;margin-bottom:12px">
        <div class="table-wrap">
            <table class="table"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
            <p id="empty" style="text-align:center;padding:48px;color:#8d99a6">No firms found. Try adjusting your filters or use AI Discovery.</p>
        </div>
        <div id="pagination-container" class="pagination-container"></div> </main>

    <script>
(()=>{
    // Constants... same as before
    const COLS=[
        {key:'chk',label:' '},{key:'sn',label:'#'},
        {key:'entityType',label:'LP/GP/Broker'},{key:'firmName',label:'Firm Name'},{key:'subType',label:'Type'},
        {key:'address',label:'Address'},{key:'country',label:'Country'},{key:'website',label:'Website'},
        {key:'companyLinkedIn',label:'Firm LinkedIn'},{key:'about',label:'About'},{key:'investmentStrategy',label:'Strategy'},
        {key:'sector',label:'Sector'},{key:'sectorDetails',label:'Sector Details'},{key:'stage',label:'Stage'},
        {key:'source',label:'Source'},{key:'actions',label:''}
    ];
    const defaultVis=['chk','sn','entityType','firmName','subType','country','website','sector','stage','source','actions'];
    const vis=new Set(JSON.parse(localStorage.getItem('visibleCols')||'null')||defaultVis);

    const alias={"lp/gp/broker":"entityType", "type":"subType", "s.no.":"sn", "lp/gp":"entityType", "lp":"entityType", "gp":"entityType","firm name":"firmName","name":"firmName","subtype":"subType","address":"address","country":"country","website":"website","company linkedin":"companyLinkedIn","firm linkedin":"companyLinkedIn","about the company":"about","about":"about","investment strategy":"investmentStrategy","strategy":"investmentStrategy","sector":"sector","sector details":"sectorDetails","stage":"stage","stage preference":"stage","source":"source","contact name":"contactName","designation":"designation","linkedin":"linkedIn","email":"email","contact number":"contactNumber"};
    const contactKeys=new Set(['contactName','designation','linkedIn','email','contactNumber']);

    const $=q=>document.querySelector(q),$$=q=>document.querySelectorAll(q);
    const UI={thead:$('#thead'),tbody:$('#tbody'),empty:$('#empty'),overlay:$('#overlay'),toast:$('#toast'),search:$('#search'),
    filterBtns:$$('.filter-buttons .btn'),qCountry:$('#q-country'),qSector:$('#q-sector'),qStage:$('#q-stage'), qSource:$('#q-source'), /* NEW */
    colBtn:$('#col-btn'),colModal:$('#col-modal'),colList:$('#col-list'),ctModal:$('#ct-modal'),ctTitle:$('#ct-title'),ctBody:$('#ct-body'),
    aiType:$('#ai-type'),aiSub:$('#ai-sub'),aiSec:$('#ai-sec'),aiGeo:$('#ai-geo'),aiBtn:$('#ai-btn'),
    fileIn:$('#file-in'),delBulk:$('#del-bulk'),expBtn:$('#exp-btn'),
    paginationContainer: $('#pagination-container') /* NEW */
    };
    
    // --- NEW: PAGINATION STATE ---
    let firms=[];
    let currentPage = 1;
    const rowsPerPage = 25;

    // --- UPDATED mapRow function ---
    const mapRow = r => ({
        _id: r.id,
        firmName: r.firm_name || r.firmName,
        entityType: r.entity_type || r.entityType,
        subType: r.sub_type || r.subType,
        companyLinkedIn: r.company_linkedin || r.companyLinkedIn,
        investmentStrategy: r.investment_strategy || r.investmentStrategy,
        sectorDetails: r.sector_details || r.sectorDetails,
        contacts: r.contacts || [],
        ...r
    });

    (async()=>{showO(true);
        try{const rows=await (await fetch('/api/firms')).json();firms=rows.map(mapRow);}catch(e){console.error(e);toast('Load failed',false);}
        finally{buildFilters();render();showO(false);}
    })();
    
    // --- UPDATED buildFilters function ---
    let view='All';
    function buildFilters(){
        const c=new Set(),s=new Set(),st=new Set(), src=new Set();
        firms.forEach(f=>{
            if(f.country)c.add(f.country);
            if(f.sector)f.sector.split(',').forEach(x=>s.add(x.trim()));
            if(f.stage)st.add(f.stage);
            if(f.source)src.add(f.source); // NEW
        });
        const fill=(sel,set, currentVal)=>{
            const cur=currentVal || sel.value;
            sel.innerHTML=sel.options[0].outerHTML + [...set].sort().map(v=>`<option>${v}</option>`).join('');
            sel.value=cur;
        };
        fill(UI.qCountry,c);fill(UI.qSector,s);fill(UI.qStage,st); fill(UI.qSource, src); // NEW
    }

    // --- EVENT LISTENERS ---
    UI.filterBtns.forEach(b=>b.addEventListener('click',()=>{
        UI.filterBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        view=b.dataset.f;
        currentPage = 1; // Reset to page 1 on filter change
        render();
    }));

    [UI.qCountry,UI.qSector,UI.qStage, UI.qSource, UI.search].forEach(el=>el.addEventListener('input', ()=>{
        currentPage = 1; // Reset to page 1 on filter change
        render();
    }));
    
    $('#q-clear').addEventListener('click',()=>{
        UI.qCountry.value=UI.qSector.value=UI.qStage.value=UI.qSource.value='';
        currentPage = 1;
        render();
    });

    // --- UPDATED render function ---
    function render(){
        UI.tbody.innerHTML=''; // Clear table body first
        
        // 1. Apply all filters to the full dataset
        const searchVal = UI.search.value.toLowerCase();
        const filteredRows = firms.filter(f =>
            (view === 'All' || f.entityType === view) &&
            (!UI.qCountry.value || f.country === UI.qCountry.value) &&
            (!UI.qSector.value || f.sector.split(',').map(x => x.trim()).includes(UI.qSector.value)) &&
            (!UI.qStage.value || f.stage === UI.qStage.value) &&
            (!UI.qSource.value || f.source === UI.qSource.value) && // NEW source filter
            Object.values(f).some(v => String(v || '').toLowerCase().includes(searchVal))
        );

        UI.empty.style.display=filteredRows.length?'none':'block';

        // 2. Paginate the filtered results
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedRows = filteredRows.slice(startIndex, endIndex);

        // 3. Render only the rows for the current page
        paginatedRows.forEach((f,i)=>{
            const tr=document.createElement('tr');
            if (f.isNew) { tr.classList.add('row-new'); delete f.isNew; }
            COLS.forEach(c=>{if(!vis.has(c.key))return;const td=document.createElement('td');
                switch(c.key){
                    case 'chk': td.innerHTML=`<input type="checkbox" class="rowchk" data-id="${f._id}">`;break;
                    case 'sn':  td.textContent = startIndex + i + 1; break; // Correct serial number across pages
                    // other cases remain the same...
                    case 'website': td.innerHTML=f.website?`<a href="${f.website.startsWith('http')?f.website:`https://${f.website}`}" target="_blank">${f.website}</a>`:'';break;
                    case 'companyLinkedIn': td.innerHTML=f.companyLinkedIn?`<a href="${f.companyLinkedIn.startsWith('http')?f.companyLinkedIn:`https://${f.companyLinkedIn}`}" target="_blank">View Profile</a>`:'';break;
                    case 'actions': td.innerHTML=`<span class="icon" title="Contacts" data-act="ct" data-id="${f._id}">👥<span class="count">${f.contacts.length}</span></span><span class="icon del" title="Delete" data-act="del" data-id="${f._id}">🗑️</span>`;break;
                    default: td.textContent=f[c.key]||''; 
                }
                td.title=td.textContent;tr.appendChild(td);
            });
            UI.tbody.appendChild(tr);
        });

        // 4. Render pagination controls
        renderPagination(filteredRows.length);
    }
    
    // --- NEW: renderPagination function ---
    function renderPagination(totalRows) {
        UI.paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        if (totalPages <= 1) return;

        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.textContent = '‹ Prev';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                render();
            }
        };
        UI.paginationContainer.appendChild(prevBtn);

        // Page number buttons
        // Logic to show a limited number of page buttons (e.g., ... 3 4 5 ...)
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            const firstBtn = document.createElement('button');
            firstBtn.className = 'page-btn';
            firstBtn.textContent = '1';
            firstBtn.onclick = () => { currentPage = 1; render(); };
            UI.paginationContainer.appendChild(firstBtn);
            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                ellipsis.style.border = 'none';
                ellipsis.style.background = 'none';
                UI.paginationContainer.appendChild(ellipsis);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'page-btn';
            pageBtn.textContent = i;
            if (i === currentPage) {
                pageBtn.classList.add('active');
            }
            pageBtn.onclick = () => {
                currentPage = i;
                render();
            };
            UI.paginationContainer.appendChild(pageBtn);
        }
        
        if (endPage < totalPages) {
             if (endPage < totalPages -1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                ellipsis.style.border = 'none';
                ellipsis.style.background = 'none';
                UI.paginationContainer.appendChild(ellipsis);
            }
            const lastBtn = document.createElement('button');
            lastBtn.className = 'page-btn';
            lastBtn.textContent = totalPages;
            lastBtn.onclick = () => { currentPage = totalPages; render(); };
            UI.paginationContainer.appendChild(lastBtn);
        }


        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.textContent = 'Next ›';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                render();
            }
        };
        UI.paginationContainer.appendChild(nextBtn);
    }
    
    // The rest of your script (modals, AI discovery, upload, etc.) remains largely the same.
    // Make sure to add `currentPage = 1;` when new data is added (e.g., after AI search or upload) to show the new items.
    
    // --- Minor adjustments to other functions ---
    // In AI Button click:
    UI.aiBtn.addEventListener('click',async()=>{
        // ... existing code ...
        if (d.added > 0) {
            d.newFirms.forEach(f => f.isNew = true);
            firms.unshift(...d.newFirms.map(mapRow));
            currentPage = 1; // Reset to page 1 to show new firms
            buildFilters();render();
        }
        // ... existing code ...
    });
    
    // In File Upload:
    UI.fileIn.addEventListener('change', e => {
        // ...
        rd.onload = async ev => {
            // ...
            // inside the final 'try' block, after getting a successful response
            if (inserted.length > 0) {
                inserted.forEach(f => f.isNew = true);
                firms.unshift(...inserted.map(mapRow));
                currentPage = 1; // Reset to page 1
                buildFilters(); render();
            }
            // ...
        };
        // ...
    });

})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LPâ€†+â€†GP FinderÂ Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>/* (same CSS you already have â€“ left intact for brevity) */</style>
</head>
<body>
  <div class="container"> <!--â€‘â€‘ sidebar and main panels identical to previous version â€‘â€‘> </div>

  <div id="toast-container"></div> <!-- toasts -->
  <!-- (all your modal HTML remains unchanged) -->

<script>
(() => {
  /* ---------------------------  CLIENT STATE  --------------------------- */
  let db = [];  // inâ€‘browser mirror of table
  const allColumns = [
    { key: 'entityType', label: 'LP/GP' }, { key: 'firmName', label: 'Firm Name' },
    { key: 'subType',    label: 'Type'   }, { key: 'address',  label: 'Address' },
    { key: 'country',    label: 'Country'}, { key: 'website',  label: 'Website' },
    { key: 'companyLinkedIn', label: 'Firm LinkedIn' }, { key: 'about', label: 'About'},
    { key: 'investmentStrategy', label: 'Strategy' }, { key: 'sector', label: 'Sector' },
    { key: 'sectorDetails', label: 'Sector Details' }, { key: 'stagePreference', label: 'Stage' }
  ];
  const contactCols = ['contactName','designation','linkedIn','email','contactNumber'];

  const view = {
    activeFilter: 'All',
    search: '',
    visible: new Set(['firmName','entityType','subType','country','sector','website','source']),
    sort: { column: 'firmName', dir: 'asc' }
  };

  /* ---------------------------  DOM SHORTCUTS  --------------------------- */
  const $ = id => document.getElementById(id);
  const dom = {
    thead: $('results-thead'), tbody: $('results-tbody'), placeholder: $('placeholder-text'),
    overlay: $('loading-overlay'), search: $('search-box'),
    btnFind: $('find-investors-btn'), upload: $('upload-input'),
    toastBox: $('toast-container')
  };

  /* ---------------------------  RENDER TABLE  --------------------------- */
  function updateView() {
    let rows = [...db];
    if (view.activeFilter !== 'All') rows = rows.filter(r => r.entityType === view.activeFilter);
    if (view.search) {
      const t = view.search.toLowerCase();
      rows = rows.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(t)));
    }
    rows.sort((a,b)=>{
      const A = a[view.sort.column] || '', B = b[view.sort.column] || '';
      return (A<B?-1: A>B?1:0) * (view.sort.dir==='asc'?1:-1);
    });

    /* header */
    dom.thead.innerHTML='';
    const hr = dom.thead.insertRow();
    [...allColumns,{key:'source',label:'Source'}].forEach(c=>{
      if(!view.visible.has(c.key)) return;
      const th=document.createElement('th');th.textContent=c.label;hr.appendChild(th);
    });
    hr.appendChild(document.createElement('th')).textContent='Actions';

    /* body */
    dom.tbody.innerHTML='';
    rows.forEach(r=>{
      const tr=dom.tbody.insertRow();
      if(r.source==='Gemini' && !r.validated) tr.classList.add('row-new');
      [...allColumns,{key:'source'}].forEach(c=>{
        if(!view.visible.has(c.key)) return;
        const td=tr.insertCell();
        td.textContent = r[c.key] || '';
      });
      tr.insertCell().innerHTML='ðŸ‘¥';
    });
    dom.placeholder.style.display = rows.length? 'none':'block';
  }

  function mergeAndDedup(list){
    const seen=new Set(db.map(f=>f.website?.toLowerCase()).filter(Boolean));
    let added=0;
    list.forEach(f=>{
      const w=(f.website||'').toLowerCase();
      if(!w||seen.has(w)) return;
      f.id='firm_'+Date.now()+Math.random();
      db.push(f);seen.add(w);added++;});
    return added;
  }

  /* ---------------------------  AI DISCOVERY  --------------------------- */
  async function findNewInvestors(){
    const entityType=$('ai-type').value;
    const subType=$('ai-subtype').value.trim();
    const sector=$('ai-sector').value.trim();
    const geo=$('ai-geo').value.trim();
    if(!subType||!sector||!geo) return toast('Fill all AI fields','error');

    loading(true);
    try{
      const res=await fetch('/api/find-investors',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({entityType,subType,sector,geo})});
      const data=await res.json();
      if(!res.ok) throw new Error(data.error||'API error');
      const added=mergeAndDedup(data);
      toast(added+' new investors added from AI.','success');
      updateView();
    }catch(e){ toast('AI search failed: '+e.message,'error'); }
    finally{loading(false);}
  }

  /* ---------------------------  UTILITIES  --------------------------- */
  function toast(msg,type='success'){
    const d=document.createElement('div');d.className='toast toast-'+type+' show';d.textContent=msg;dom.toastBox.appendChild(d);
    setTimeout(()=>{d.classList.remove('show');d.addEventListener('transitionend',()=>d.remove());},4000);
  }
  const loading=f=>dom.overlay.style.display=f?'flex':'none';

  /* ---------------------------  EVENT BINDINGS  --------------------------- */
  dom.btnFind.onclick=findNewInvestors;
  dom.search.oninput=e=>{view.search=e.target.value;updateView();};
  /* (other buttons/listeners from your original version can be reâ€‘attached here) */

  updateView();
})();
</script>
</body>
</html>

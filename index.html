<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Magistral LP-GP Finder v2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>/*  â€”â€”----  all CSS unchanged, trimmed for brevity  â€”â€”----  */</style>
</head>
<body>
<!-- ------------- sidebar + main markup identical to your file ------------- -->
<!-- (omitted here for brevity â€“ nothing changed in the HTML structure) -->
<!-- keep everything up to the closing </main> / modals exactly as you have -->

<script>
(()=>{/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATE & DOM SHORTCUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const COLS=[{key:'sn',label:'#'},{key:'entityType',label:'LP/GP/Broker'},{key:'firmName',label:'Firm Name'},
{key:'subType',label:'Type'},{key:'address',label:'Address'},{key:'country',label:'Country'},
{key:'website',label:'Website'},{key:'companyLinkedIn',label:'Firm LinkedIn'},{key:'about',label:'About'},
{key:'investmentStrategy',label:'Strategy'},{key:'sector',label:'Sector'},{key:'sectorDetails',label:'Sector Details'},
{key:'stage',label:'Stage'},{key:'source',label:'Source'},{key:'actions',label:''}];

let firms=[];let filter='All';
const defaultVisible=['sn','entityType','firmName','subType','country','website','sector','stage','source','actions'];
const visible=new Set(JSON.parse(localStorage.getItem('visibleCols')||'null')||defaultVisible);

const $=q=>document.querySelector(q),$$=q=>document.querySelectorAll(q);
const UI={thead:$('#thead'),tbody:$('#tbody'),empty:$('#empty'),overlay:$('#overlay'),toast:$('#toast'),search:$('#search'),
          filterBtns:$$('.filter-buttons .btn'),qCountry:$('#q-country'),qSector:$('#q-sector'),qStage:$('#q-stage'),
          colBtn:$('#col-btn'),colModal:$('#col-modal'),colList:$('#col-list'),
          ctModal:$('#ct-modal'),ctTitle:$('#ct-title'),ctBody:$('#ct-body'),
          aiType:$('#ai-type'),aiSub:$('#ai-sub'),aiSec:$('#ai-sec'),aiGeo:$('#ai-geo'),aiBtn:$('#ai-btn')};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const showOverlay=f=>UI.overlay.style.display=f?'flex':'none';
const toast=(msg,ok=true)=>{const t=document.createElement('div');t.className=`toast ${ok?'ok':'err'}`;t.textContent=msg;
 UI.toast.appendChild(t);requestAnimationFrame(()=>t.classList.add('show'));
 setTimeout(()=>{t.classList.remove('show');t.addEventListener('transitionend',()=>t.remove());},3500);};

/* DB â†’ UI key mapping */
const mapRow=r=>({
  _id:r.id, uid:`d${r.id}`,
  firmName:r.firm_name, entityType:r.entity_type, subType:r.sub_type,
  address:r.address, country:r.country, website:r.website, companyLinkedIn:r.company_linkedin,
  about:r.about, investmentStrategy:r.investment_strategy, sector:r.sector,
  sectorDetails:r.sector_details, stage:r.stage, source:r.source,
  validated:!!r.validated, contacts:[]          // contacts later
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOAD SAVED ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async()=>{showOverlay(true);
 try{const rows=await (await fetch('/api/firms')).json();firms=rows.map(mapRow);}
 catch{toast('Could not load saved rows',false);}
 finally{rebuildFilters();render();showOverlay(false);}
})();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RENDER TABLE & FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function rebuildFilters(){
 const c=new Set(),s=new Set(),st=new Set();
 firms.forEach(f=>{if(f.country)c.add(f.country);
   if(f.sector)f.sector.split(',').forEach(x=>s.add(x.trim()));
   if(f.stage)st.add(f.stage);});
 const fill=(sel,set)=>{const cur=sel.value;sel.innerHTML='<option value="">All</option>'+[...set].sort().map(v=>`<option>${v}</option>`).join('');sel.value=cur;};
 fill(UI.qCountry,c);fill(UI.qSector,s);fill(UI.qStage,st);
}

function render(){
 UI.thead.innerHTML=UI.tbody.innerHTML='';
 const trH=document.createElement('tr');
 COLS.forEach(c=>{if(visible.has(c.key)){const th=document.createElement('th');th.textContent=c.label;trH.appendChild(th);}});
 UI.thead.appendChild(trH);

 const term=UI.search.value.toLowerCase(),fc=UI.qCountry.value,fs=UI.qSector.value.toLowerCase(),fst=UI.qStage.value;
 const rows=firms.filter(f=>(filter==='All'||f.entityType===filter)&&(!fc||f.country===fc)&&(!fst||f.stage===fst)
   &&(!fs||f.sector.toLowerCase().split(',').some(x=>x.trim()===fs))
   &&Object.values(f).some(v=>String(v).toLowerCase().includes(term)));
 UI.empty.style.display=rows.length?'none':'block';

 rows.forEach((f,i)=>{
  const tr=document.createElement('tr');if(f.source==='Gemini'&&!f.validated)tr.classList.add('row-new');
  COLS.forEach(c=>{if(!visible.has(c.key))return;const td=document.createElement('td');let v=f[c.key]||'';if(c.key==='sn')v=i+1;
    if((c.key==='website'||c.key==='companyLinkedIn')&&v)td.innerHTML=`<a href="${v.startsWith('http')?v:`https://${v}`}" target="_blank">${v}</a>`;
    else if(c.key==='actions')td.innerHTML=`<span class="icon" data-id="${f._id}" data-act="contacts">ğŸ‘¥</span><span class="icon del" data-id="${f._id}" data-act="del">ğŸ—‘ï¸</span>`;
    else td.textContent=v;td.title=v;tr.appendChild(td);});
  UI.tbody.appendChild(tr);});
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ COLUMN MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
UI.colBtn.addEventListener('click',()=>{
 UI.colList.innerHTML='';COLS.forEach(c=>{if(c.key==='actions')return;
  const li=document.createElement('li');li.dataset.k=c.key;li.textContent=c.label;
  li.classList.toggle('selected',visible.has(c.key));UI.colList.appendChild(li);});
 UI.colModal.style.display='flex';});
UI.colModal.addEventListener('click',e=>{if(e.target===UI.colModal||e.target.classList.contains('close'))UI.colModal.style.display='none';});
UI.colList.addEventListener('click',e=>{
 const li=e.target.closest('li');if(!li)return;const k=li.dataset.k;
 if(visible.has(k))visible.delete(k);else visible.add(k);
 li.classList.toggle('selected');localStorage.setItem('visibleCols',JSON.stringify([...visible]));render();
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FILTER, SEARCH, CLEAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[...UI.filterBtns].forEach(b=>b.addEventListener('click',()=>{[...UI.filterBtns].forEach(x=>x.classList.remove('active'));b.classList.add('active');filter=b.dataset.f;render();}));
UI.search.addEventListener('input',render);
[UI.qCountry,UI.qSector,UI.qStage].forEach(s=>s.addEventListener('change',render));
$('#q-clear').addEventListener('click',()=>{UI.qCountry.value=UI.qSector.value=UI.qStage.value='';render();});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ROW ICONS (contacts / delete) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
UI.tbody.addEventListener('click',async e=>{
 if(!e.target.classList.contains('icon'))return;
 const id=e.target.dataset.id,act=e.target.dataset.act,rec=firms.find(r=>r._id==id);if(!rec)return;
 if(act==='contacts'){alert('Contacts coming soon');return;}
 if(!confirm('Delete this entry permanently?'))return;
 try{await fetch(`/api/firms/${id}`,{method:'DELETE'});}catch{}
 firms=firms.filter(r=>r._id!=id);render();toast('Entry deleted');
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AI DISCOVERY BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
UI.aiBtn.addEventListener('click',async()=>{
 const body={entityType:UI.aiType.value,subType:UI.aiSub.value,sector:UI.aiSec.value,geo:UI.aiGeo.value};
 showOverlay(true);
 try{
   const res=await fetch('/api/find-investors',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
   const d=await res.json();if(!res.ok)throw new Error(d.error||res.statusText);
   firms.push(...d.newFirms);rebuildFilters();render();toast(`${d.added} firms added via Gemini`);
 }catch(err){toast(err.message||'Gemini error',false);}
 finally{showOverlay(false);}
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UPLOAD  (Excel / CSV) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('#file-in').addEventListener('change',e=>{
 const f=e.target.files[0];if(!f)return;showOverlay(true);
 const reader=new FileReader();
 reader.onload=ev=>{
  try{
    const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{defval:''});
    if(!rows.length)throw new Error('empty');
    const exist=new Map(firms.map(x=>[(x.website||x.firmName).toLowerCase(),x]));let added=0;
    rows.forEach(r=>{
      const obj={contacts:[],validated:true,source:'Upload'};
      const contact={};Object.entries(r).forEach(([k,v])=>{
        const key=k.toLowerCase().replace(/\s+/g,'');if(contactKeys.has(key))contact[key]=v;else obj[key]=v;});
      if(Object.values(contact).some(Boolean))obj.contacts.push(contact);
      if(!obj.firmName)return;
      const key=(obj.website||obj.firmName).toLowerCase();
      if(exist.has(key)){if(obj.contacts.length)exist.get(key).contacts.push(...obj.contacts);}
      else{obj.uid=`u${Date.now()}_${Math.random()}`;firms.push(obj);exist.set(key,obj);added++;}});
    toast(`${added} new companies added`,true);rebuildFilters();render();
  }catch{toast('Upload failed',false);}
  finally{showOverlay(false);e.target.value='';}};
 reader.onerror=()=>{showOverlay(false);toast('Could not read file',false);};
 reader.readAsArrayBuffer(f);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EXPORT CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('#exp-btn').addEventListener('click',()=>{
 if(!firms.length){toast('Nothing to export',false);return;}
 const hdr=COLS.filter(c=>c.key!=='actions').map(c=>c.key).join(',');
 const rows=firms.map(f=>COLS.filter(c=>c.key!=='actions').map(c=>`"${(f[c.key]||'').replace(/"/g,'""')}"`).join(',')).join('\n');
 const blob=new Blob([hdr+'\n'+rows],{type:'text/csv'});const a=document.createElement('a');
 a.href=URL.createObjectURL(blob);a.download='magistral_lp_gp.csv';a.click();
});
})();
</script>
</body>
</html>

<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Magistral LP-GP Finder v2</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ‚Äî‚Äî identical look ‚Äî‚Äî */
:root{--blue:#013463;--teal:#00958f;--grey:#687683;--bg:#f5f7fa;--white:#fff;--border:#d6dde5;--shadow:0 2px 6px rgba(0,0,0,.08);--font:"Inter",system-ui,-apple-system,"Segoe UI",sans-serif}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:#1f2d3d;display:flex;min-height:100vh;overflow:auto}
a{color:var(--blue);text-decoration:none}
a:hover{text-decoration:underline}
.sidebar{flex:0 0 310px;background:var(--white);border-right:1px solid var(--border);padding:22px;display:flex;flex-direction:column;gap:26px;overflow:auto}
.main{flex:1;display:flex;flex-direction:column;padding:22px;position:relative}
.panel{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:20px;box-shadow:var(--shadow)}
.panel h2{font-size:18px;font-weight:700;margin-bottom:12px;color:var(--blue);border-bottom:1px solid var(--border);padding-bottom:8px}
/* buttons & inputs identical to before */
.btn{border:none;border-radius:6px;padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer;transition:.2s;width:100%;line-height:1.25;text-align:center}
.btn-pri{background:var(--teal);color:#fff}.btn-pri:hover{background:#007c77}
.btn-sec{background:var(--grey);color:#fff}.btn-sec:hover{background:#556270}
.filter-buttons{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.filter-buttons .btn{padding:6px 0;font-size:13px;background:#e9edf2;color:#344454;border:1px solid transparent}
.filter-buttons .active{background:var(--blue);color:#fff}
input,select{width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:6px;font-size:14px;background:var(--white)}
input:focus,select:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 2px rgba(0,149,143,.25)}
/* table */
.table-wrap{flex:1;background:var(--white);border:1px solid var(--border);border-radius:10px;overflow:auto;box-shadow:var(--shadow)}
.table{width:100%;min-width:1800px;border-collapse:collapse;font-size:13px;table-layout:fixed}
th,td{padding:8px 10px;border-bottom:1px solid var(--border);white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
th{background:var(--bg);color:var(--blue);font-weight:600;text-transform:uppercase;position:sticky;top:0;z-index:3}
tr:hover td{background:#f0f4f8}
.row-new{background:#fffbe7}
.icon{cursor:pointer;font-size:16px;color:var(--blue); display:inline-flex; align-items:center; gap:4px;}
.icon .count{font-size:12px; background:var(--grey); color:white; padding:1px 5px; border-radius:10px;}
.icon.del{color:#b60000;margin-left:8px}
/* overlay / toast (unchanged) */
#overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.55);z-index:300}
.spinner{width:44px;height:44px;border:5px solid rgba(0,0,0,.12);border-top-color:var(--teal);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;top:22px;right:24px;z-index:600}
.toast{padding:11px 17px;border-radius:8px;color:#fff;font-weight:600;margin-bottom:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(-10px);transition:.3s}
.toast.show{opacity:1;transform:none}.toast.ok{background:var(--teal)}.toast.err{background:#c0392b}
/* modal styling */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:500}
.modal-box{background:#fff;border-radius:10px;padding:24px;width:92%;max-width:820px;max-height:85%;overflow:auto;box-shadow:var(--shadow)}
.modal-box h3{font-size:18px;font-weight:700;margin-bottom:14px;color:var(--blue); border-bottom:1px solid var(--border); padding-bottom:10px;}
.modal-box .table-wrap{border:1px solid var(--border); border-radius:8px; overflow:auto; max-height: 60vh;}
.modal-box table{width:100%;border-collapse:collapse;font-size:14px;}
.modal-box th, .modal-box td{padding:10px 12px;border-bottom:1px solid var(--border); white-space:normal;}
.modal-box th {background: var(--bg); color: var(--blue); font-weight:600; position:sticky; top:0;}
.modal-box tr:last-child td {border-bottom:none;}
.modal-box .close-btn-wrap {margin-top:20px; display:flex; justify-content:flex-end;}
#col-list{list-style:none;margin:0;padding:0;display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
#col-list li{padding:6px 10px;border:1px solid var(--border);border-radius:6px;cursor:pointer;text-align:center;user-select:none}
#col-list li.selected{background:var(--teal);color:#fff;border-color:var(--teal)}
.panel.quick-filters label{display:block;font-size:13px;margin-bottom:4px;color:#344454}
.panel.quick-filters select{margin-bottom:12px}
.panel.manage-list{display:flex;flex-direction:column;gap:10px}
.panel.manage-list .btn{width:100%}
</style>
</head><body>
<aside class="sidebar">
  <div class="panel"><h2>View</h2>
    <div class="filter-buttons">
      <button class="btn active" data-f="All">All</button><button class="btn" data-f="LP">LPs</button>
      <button class="btn" data-f="GP">GPs</button><button class="btn" data-f="Broker">Brokers</button>
      <button class="btn" data-f="Other">Others</button>
    </div>
    <button id="col-btn" class="btn btn-sec" style="margin-top:14px">Configure Columns</button>
  </div>

  <div class="panel quick-filters"><h2>Quick Filters</h2>
    <label>Country</label><select id="q-country"><option value="">All</option></select>
    <label>Sector</label><select id="q-sector"><option value="">All</option></select>
    <label>Stage</label><select id="q-stage"><option value="">All</option></select>
    <button id="q-clear" class="btn btn-sec">Clear</button>
  </div>

  <div class="panel"><h2>AI Discovery</h2>
    <label style="font-size:13px">Entity Type</label>
    <select id="ai-type"><option>LP</option><option>GP</option><option>Broker</option><option>Other</option></select>
    <label style="font-size:13px;margin-top:12px">Specific Type</label><input id="ai-sub" placeholder="Family Office">
    <label style="font-size:13px;margin-top:12px">Sector</label><input id="ai-sec" placeholder="Health Care">
    <label style="font-size:13px;margin-top:12px">Geography</label><input id="ai-geo" placeholder="USA">
    <button id="ai-btn" class="btn btn-pri" style="margin-top:16px">‚ú® Find Investors</button>
  </div>

  <div class="panel manage-list"><h2>Manage List</h2>
    <label class="btn btn-sec" for="file-in">Upload Excel/CSV</label>
    <input type="file" id="file-in" accept=".xlsx,.xls,.csv" hidden>
    <button id="del-bulk" class="btn btn-sec">Delete Selected</button>
    <button id="exp-btn" class="btn btn-sec">Export CSV</button>
  </div>
</aside>

<main class="main">
  <div id="overlay"><div class="spinner"></div></div>
  <input id="search" placeholder="Search‚Ä¶" style="padding:9px 12px;border:1px solid var(--border);border-radius:6px;width:100%;margin-bottom:12px">
  <div class="table-wrap">
    <table class="table"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
    <p id="empty" style="text-align:center;padding:32px;color:#8d99a6">Upload a file or use AI Discovery to get started.</p>
  </div>
</main>
<div id="toast"></div>

<div class="modal" id="col-modal"><div class="modal-box" style="width:360px">
  <h3>Visible Columns</h3><ul id="col-list"></ul>
  <div class="close-btn-wrap"><button class="btn btn-pri close" style="width:120px">Done</button></div>
</div></div>

<div class="modal" id="ct-modal"><div class="modal-box">
  <h3 id="ct-title">Contacts</h3>
  <div class="table-wrap">
    <table><thead><tr><th>Name</th><th>Designation</th><th>Email</th><th>LinkedIn</th><th>Contact&nbsp;No.</th></tr></thead><tbody id="ct-body"></tbody></table>
  </div>
  <div class="close-btn-wrap"><button class="btn btn-pri close" style="width:120px">Close</button></div>
</div></div>

<script>
(()=>{/* ‚Äî‚Äî constants ‚Äî‚Äî */
const COLS=[
  {key:'chk',label:' '},{key:'sn',label:'#'},
  {key:'entityType',label:'LP/GP/Broker'},{key:'firmName',label:'Firm Name'},{key:'subType',label:'Type'},
  {key:'address',label:'Address'},{key:'country',label:'Country'},{key:'website',label:'Website'},
  {key:'companyLinkedIn',label:'Firm LinkedIn'},{key:'about',label:'About'},{key:'investmentStrategy',label:'Strategy'},
  {key:'sector',label:'Sector'},{key:'sectorDetails',label:'Sector Details'},{key:'stage',label:'Stage'},
  {key:'source',label:'Source'},{key:'actions',label:''}
];
const defaultVis=['chk','sn','entityType','firmName','subType','country','website','sector','stage','source','actions'];
const vis=new Set(JSON.parse(localStorage.getItem('visibleCols')||'null')||defaultVis);

const alias={"lp/gp/broker":"entityType","lp/gp":"entityType","lp":"entityType","gp":"entityType","firm name":"firmName","name":"firmName",
"type":"subType","subtype":"subType","address":"address","country":"country","website":"website","company linkedin":"companyLinkedIn",
"firm linkedin":"companyLinkedIn","about the company":"about","about":"about","investment strategy":"investmentStrategy","strategy":"investmentStrategy",
"sector":"sector","sector details":"sectorDetails","stage":"stage","stage preference":"stage","source":"source",
"contact name":"contactName","designation":"designation","linkedin":"linkedIn","email":"email","contact number":"contactNumber"};
const contactKeys=new Set(['contactName','designation','linkedIn','email','contactNumber']);

/* ‚Äî‚Äî dom ‚Äî‚Äî */
const $=q=>document.querySelector(q),$$=q=>document.querySelectorAll(q);
const UI={thead:$('#thead'),tbody:$('#tbody'),empty:$('#empty'),overlay:$('#overlay'),toast:$('#toast'),search:$('#search'),
filterBtns:$$('.filter-buttons .btn'),qCountry:$('#q-country'),qSector:$('#q-sector'),qStage:$('#q-stage'),
colBtn:$('#col-btn'),colModal:$('#col-modal'),colList:$('#col-list'),ctModal:$('#ct-modal'),ctTitle:$('#ct-title'),ctBody:$('#ct-body'),
aiType:$('#ai-type'),aiSub:$('#ai-sub'),aiSec:$('#ai-sec'),aiGeo:$('#ai-geo'),aiBtn:$('#ai-btn'),
fileIn:$('#file-in'),delBulk:$('#del-bulk')};

const showO=f=>UI.overlay.style.display=f?'flex':'none';
const toast=(m,ok=true)=>{const t=document.createElement('div');t.className=`toast ${ok?'ok':'err'}`;t.textContent=m;
 UI.toast.appendChild(t);requestAnimationFrame(()=>t.classList.add('show'));
 setTimeout(()=>{t.classList.remove('show');t.addEventListener('transitionend',()=>t.remove());},3000);};

/* ‚Äî‚Äî data ‚Äî‚Äî */
let firms=[];
const mapRow=r=>({_id:r.id,firmName:r.firm_name||r.firmName,entityType:r.entity_type||r.entityType,subType:r.sub_type||r.subType,address:r.address,
country:r.country,website:r.website,companyLinkedIn:r.company_linkedin||r.companyLinkedIn,about:r.about,investmentStrategy:r.investment_strategy||r.investmentStrategy,
sector:r.sector,sectorDetails:r.sector_details||r.sectorDetails,stage:r.stage,source:r.source,contacts:r.contacts||[]});

/* ‚Äî‚Äî load existing ‚Äî‚Äî */
(async()=>{showO(true);
 try{const rows=await (await fetch('/api/firms')).json();firms=rows.map(mapRow);}catch(e){console.error(e);toast('Load failed',false);}
 finally{buildFilters();render();showO(false);}
})();

/* ‚Äî‚Äî build filters ‚Äî‚Äî */
let view='All';
function buildFilters(){const c=new Set(),s=new Set(),st=new Set();
 firms.forEach(f=>{if(f.country)c.add(f.country);if(f.sector)f.sector.split(',').forEach(x=>s.add(x.trim()));if(f.stage)st.add(f.stage);});
 const fill=(sel,set)=>{const cur=sel.value;sel.innerHTML='<option value="">All</option>'+[...set].sort().map(v=>`<option>${v}</option>`).join('');sel.value=cur;};
 fill(UI.qCountry,c);fill(UI.qSector,s);fill(UI.qStage,st);}
UI.filterBtns.forEach(b=>b.addEventListener('click',()=>{UI.filterBtns.forEach(x=>x.classList.remove('active'));b.classList.add('active');view=b.dataset.f;render();}));
[UI.qCountry,UI.qSector,UI.qStage,UI.search].forEach(el=>el.addEventListener('input',render));
$('#q-clear').addEventListener('click',()=>{UI.qCountry.value=UI.qSector.value=UI.qStage.value='';render();});

/* ‚Äî‚Äî render table ‚Äî‚Äî */
function render(){
 UI.thead.innerHTML=UI.tbody.innerHTML='';
 /* header row */
 const trH=document.createElement('tr');
 COLS.forEach(c=>{if(!vis.has(c.key))return;
   const th=document.createElement('th');
   if(c.key==='chk')th.innerHTML='<input type="checkbox" id="sel-all">';
   else th.textContent=c.label;trH.appendChild(th);});
 UI.thead.appendChild(trH);

 /* rows */
 const rows=firms.filter(f=>(view==='All'||f.entityType===view)
  &&(!UI.qCountry.value||f.country===UI.qCountry.value)
  &&(!UI.qSector.value||f.sector.split(',').map(x=>x.trim()).includes(UI.qSector.value))
  &&(!UI.qStage.value||f.stage===UI.qStage.value)
  &&Object.values(f).some(v=>String(v||'').toLowerCase().includes(UI.search.value.toLowerCase())));
 UI.empty.style.display=rows.length?'none':'block';

 rows.forEach((f,i)=>{const tr=document.createElement('tr');
   COLS.forEach(c=>{if(!vis.has(c.key))return;const td=document.createElement('td');
     switch(c.key){
       case 'chk': td.innerHTML=`<input type="checkbox" class="rowchk" data-id="${f._id}">`;break;
       case 'sn':  td.textContent=i+1;break;
       case 'website':
         td.innerHTML=f.website?`<a href="${f.website.startsWith('http')?f.website:`https://${f.website}`}" target="_blank">${f.website}</a>`:'';break;
       case 'companyLinkedIn':
         td.innerHTML=f.companyLinkedIn?`<a href="${f.companyLinkedIn}" target="_blank">View Profile</a>`:'';break;
       case 'actions':
         td.innerHTML=`<span class="icon" title="Contacts" data-act="ct" data-id="${f._id}">üë•<span class="count">${f.contacts.length}</span></span>
                       <span class="icon del" title="Delete" data-act="del" data-id="${f._id}">üóëÔ∏è</span>`;break;
       default: td.textContent=f[c.key]||''; }
     td.title=td.textContent;tr.appendChild(td);});
   UI.tbody.appendChild(tr);});
}

/* ‚Äî‚Äî column modal ‚Äî‚Äî */
UI.colBtn.addEventListener('click',()=>{
 UI.colList.innerHTML='';COLS.forEach(c=>{if(c.key==='actions'||c.key==='chk')return;
   const li=document.createElement('li');li.textContent=c.label;li.dataset.k=c.key;
   li.classList.toggle('selected',vis.has(c.key));UI.colList.appendChild(li);} );
 UI.colModal.style.display='flex';});
UI.colModal.addEventListener('click',e=>{if(e.target.closest('.close')||e.target===UI.colModal)UI.colModal.style.display='none';});
UI.colList.addEventListener('click',e=>{const li=e.target.closest('li');if(!li)return;const k=li.dataset.k;
 vis.has(k)?vis.delete(k):vis.add(k);li.classList.toggle('selected');
 localStorage.setItem('visibleCols',JSON.stringify([...vis]));render();});

/* ‚Äî‚Äî select all ‚Äî‚Äî */
UI.thead.addEventListener('change',e=>{if(e.target.id!=='sel-all')return;
 UI.tbody.querySelectorAll('.rowchk').forEach(cb=>cb.checked=e.target.checked);});

/* ‚Äî‚Äî row icons (contacts & delete) ‚Äî‚Äî */
UI.tbody.addEventListener('click',async e=>{
 const icon=e.target.closest('[data-act]');if(!icon)return;
 const id=icon.dataset.id,act=icon.dataset.act;
 if(act==='ct'){const row=firms.find(x=>x._id==id);UI.ctTitle.textContent=`Contacts ‚Äì ${row?.firmName||''}`;
   UI.ctBody.innerHTML=row?.contacts?.length?row.contacts.map(c=>
     `<tr><td>${c.contactName||''}</td><td>${c.designation||''}</td><td>${c.email?`<a href="mailto:${c.email}">${c.email}</a>`:''}</td>
      <td>${c.linkedIn?`<a href="${c.linkedIn.startsWith('http')?c.linkedIn:`https://${c.linkedIn}`}" target="_blank">View Profile</a>`:''}</td><td>${c.contactNumber||''}</td></tr>`).join('')
     : '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--grey)">No contacts yet</td></tr>';
   UI.ctModal.style.display='flex';return;}
 if(act==='del'){
  if(!confirm('Are you sure you want to delete this firm?'))return;
  showO(true);
  try{
    const res=await fetch(`/api/firms/${id}`,{method:'DELETE'});
    if(!res.ok) throw new Error('Failed to delete');
    firms=firms.filter(x=>x._id!=id);render();toast('Deleted successfully',true);
  } catch(e){ toast(e.message, false); }
  finally{ showO(false); }
 }});

UI.ctModal.addEventListener('click',e=>{if(e.target.closest('.close')||e.target===UI.ctModal)UI.ctModal.style.display='none';});


/* ‚Äî‚Äî bulk delete ‚Äî‚Äî */
UI.delBulk.addEventListener('click',async()=>{
 const ids=[...UI.tbody.querySelectorAll('.rowchk:checked')].map(cb=>cb.dataset.id);
 if(!ids.length){toast('Nothing selected',false);return;}
 if(!confirm(`Delete ${ids.length} selected firms?`))return;
 showO(true);
 try{
  await Promise.all(ids.map(id=>fetch(`/api/firms/${id}`,{method:'DELETE'})));
  firms=firms.filter(x=>!ids.includes(String(x._id)));render();toast(`Deleted ${ids.length} firms.`,true);
 } catch(e){ toast('Bulk delete failed.', false); }
 finally{ showO(false); }
});

/* ‚Äî‚Äî AI Discovery ‚Äî‚Äî */
UI.aiBtn.addEventListener('click',async()=>{
 const payload={entityType:UI.aiType.value.trim(),subType:UI.aiSub.value.trim(),
   sector:UI.aiSec.value.trim(),geo:UI.aiGeo.value.trim()};
  if(!payload.geo) { toast('Geography is a required field.', false); return; }
 showO(true);
 try{
   const res=await fetch('/api/find-investors',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
   const d=await res.json();if(!res.ok)throw new Error(d.error||res.statusText);
   if (d.added > 0) {
     firms.unshift(...d.newFirms.map(mapRow));
     buildFilters();render();
     UI.tbody.querySelectorAll('tr').forEach((tr, i) => {
       if (i < d.added) tr.classList.add('row-new');
     });
   }
   toast(`${d.added} new firms added`,true);
 }catch(e){toast(e.message||'Gemini error',false);}finally{showO(false);}
});

// ==========  UPLOAD  ==========
 UI.fileIn.addEventListener('change', e => {
   const f = e.target.files[0];
   if (!f) return;
   showO(true);

   const rd = new FileReader();
   rd.onload = async ev => {
     try {
       const wb   = XLSX.read(new Uint8Array(ev.target.result), { type:'array' });
       const raw  = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' });

       /* ---- normalise keys & merge duplicates ---- */
       const byWeb = new Map();
       raw.forEach(r => {
         const obj = {}; const contact = {};
         for (const [k, v] of Object.entries(r)) {
           const key = (alias[k.toLowerCase().trim()] || k).replace(/\s+/g, '');
           if (v) (contactKeys.has(key) ? contact : obj)[key] = v;
         }

         const key = (obj.website || obj.firmName || '').toLowerCase().trim();
         if (!key) return;

         if (!byWeb.has(key)) {
           byWeb.set(key, { ...obj, contacts: [] });
         }

         const record = byWeb.get(key);
         // Fill empty company details from subsequent rows
         Object.keys(obj).forEach(k => { if (!record[k]) record[k] = obj[k]; });
         // Add contact if any contact info is present
         if (Object.values(contact).some(Boolean)) record.contacts.push(contact);
       });

       const deduped = [...byWeb.values()];
       if (!deduped.length) throw new Error("No valid data to import.");

       /* ---- POST once ---- */
       const res = await fetch('/api/firms', {
         method : 'POST',
         headers: { 'content-type':'application/json' },
         body   : JSON.stringify(deduped)
       });
       const { inserted = [], error } = await res.json();
       if (error) throw new Error(error);

       if (inserted.length > 0) {
        firms.unshift(...inserted.map(mapRow));
        buildFilters(); render();
         UI.tbody.querySelectorAll('tr').forEach((tr, i) => {
           if (i < inserted.length) tr.classList.add('row-new');
         });
       }
       toast(`${inserted.length} firms added or updated.`, true);

     } catch (err) {
       console.error(err);
       toast(err.message || 'Upload failed', false);
     } finally {
       showO(false);
       e.target.value = '';
     }
   };
   rd.readAsArrayBuffer(f);
 });


/* ‚Äî‚Äî export ‚Äî‚Äî */
$('#exp-btn').addEventListener('click',()=>{
 const toExport = firms.filter(f => {
  const cb = UI.tbody.querySelector(`.rowchk[data-id="${f._id}"]`);
  return cb && cb.checked;
 });
 const data = toExport.length > 0 ? toExport : firms;
 if(!data.length){toast('Nothing to export',false);return;}

 const colsToExp = COLS.filter(c => vis.has(c.key) && c.key!=='chk' && c.key!=='actions');
 let csv = colsToExp.map(c => c.label).join(',') + '\n';

 data.forEach(f => {
  csv += colsToExp.map(c => {
    let val = f[c.key] || '';
    val = String(val).replace(/"/g, '""');
    return `"${val}"`;
  }).join(',') + '\n';
 });

 const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
 const a=document.createElement('a');
 a.href=URL.createObjectURL(blob);
 a.download='magistral_lp_gp_export.csv';
 a.click();
 URL.revokeObjectURL(a.href);
 toast(toExport.length > 0 ? 'Exporting selected rows' : 'Exporting all visible rows', true);
});
})();
</script>
</body></html>
